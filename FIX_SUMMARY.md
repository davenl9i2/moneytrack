# æŸ¥è©¢åŠŸèƒ½å•é¡Œä¿®å¾©ç¸½çµ

## ğŸ› å•é¡Œæè¿°

ä½¿ç”¨è€…å›å ±å…©å€‹å•é¡Œï¼š
1. **æŸ¥è©¢æ™‚æ–°å¢ 0 å…ƒè¨˜éŒ„** - ç•¶ä½¿ç”¨è€…è©¢å•ã€Œæˆ‘æ˜¨å¤©èŠ±å¤šå°‘éŒ¢?ã€æ™‚ï¼Œç³»çµ±æœƒæ–°å¢ä¸€ç­† 0 å…ƒçš„è¨˜éŒ„
2. **æŸ¥è©¢å›è¦†ã€Œç„¡è³‡æ–™ã€** - å³ä½¿ç¶²é ä¸­æœ‰è¨˜éŒ„ï¼ŒæŸ¥è©¢æ™‚ä»å›è¦†æ²’æœ‰è³‡æ–™

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### å•é¡Œ 1: æ–°å¢ 0 å…ƒè¨˜éŒ„
**åŸå› **: 
- LLM å¯èƒ½æ²’æœ‰æ­£ç¢ºè­˜åˆ¥ intent ç‚º `QUERY`ï¼Œå°è‡´èµ°åˆ° `RECORD` é‚è¼¯
- æˆ–è€… LLM è¨­å®šäº† `intent: "QUERY"` ä½† `amount` ä¸æ˜¯ 0ï¼Œå°è‡´é©—è­‰å¤±æ•—

### å•é¡Œ 2: æŸ¥è©¢ç„¡è³‡æ–™
**åŸå› **:
- æ—¥æœŸç¯„åœå•é¡Œï¼š`queryEndDate` åªè¨­å®šåˆ°ç•¶å¤© 00:00:00ï¼Œç„¡æ³•åŒ…å«ç•¶å¤©çš„è¨˜éŒ„
- ç¼ºå°‘ debug loggingï¼Œç„¡æ³•è¿½è¹¤æŸ¥è©¢æ¢ä»¶å’Œçµæœ

## âœ… ä¿®å¾©æ–¹æ¡ˆ

### 1. åŠ å¼· LLM Prompt (`lib/groq.ts`)

**æ”¹é€²å…§å®¹**:
```typescript
// æ˜ç¢ºè¦æ±‚ QUERY intent å¿…é ˆè¨­ amount = 0
"amount": number (MUST be 0 for QUERY and CHAT intents, only set for RECORD)

// å¼·èª¿æŸ¥è©¢é—œéµå­—
Keywords indicating QUERY: "å¤šå°‘", "èŠ±äº†", "æ”¶å…¥", "æ”¯å‡º", "çµ±è¨ˆ", "ç¸½å…±", "?", "ï¼Ÿ"

// åŠ å…¥æ›´å¤šç¯„ä¾‹
- "ä»Šå¤©èŠ±äº†å¤šå°‘" â†’ {"intent": "QUERY", "amount": 0, ...}
- "æœ¬æœˆæ”¶å…¥" â†’ {"intent": "QUERY", "amount": 0, ...}
```

**å½±éŸ¿**: LLM ç¾åœ¨æ›´æ¸…æ¥šåœ°çŸ¥é“ä½•æ™‚æ‡‰è©²è¨­å®š `intent: "QUERY"` å’Œ `amount: 0`

### 2. ä¿®æ­£æ—¥æœŸç¯„åœæŸ¥è©¢ (`app/api/line/webhook/route.ts`)

**Before**:
```typescript
if (queryEndDate) {
    where.date.lte = new Date(queryEndDate);
}
```

**After**:
```typescript
if (queryEndDate) {
    // Set to end of day to include all records on that day
    const endDate = new Date(queryEndDate);
    endDate.setHours(23, 59, 59, 999);
    where.date.lte = endDate;
}
```

**å½±éŸ¿**: ç¾åœ¨æŸ¥è©¢ã€Œä»Šå¤©ã€æˆ–ã€Œæ˜¨å¤©ã€æœƒåŒ…å«ç•¶å¤©æ‰€æœ‰æ™‚é–“çš„è¨˜éŒ„

### 3. é˜²æ­¢ 0 å…ƒè¨˜éŒ„ (`app/api/line/webhook/route.ts`)

**æ–°å¢é©—è­‰**:
```typescript
if (intent === 'RECORD') {
    // Validate amount exists and is not 0
    if (!amount || amount === 0) {
        console.warn('âš ï¸ Invalid amount for RECORD intent:', amount);
        // å›è¦†ä½¿ç”¨è€…æç¤ºè¨Šæ¯
        return; // Don't save 0 amount records
    }
    
    // åªæœ‰é€šéé©—è­‰æ‰æœƒå„²å­˜
    await prisma.expense.create({...});
}
```

**å½±éŸ¿**: å³ä½¿ LLM éŒ¯èª¤è­˜åˆ¥ï¼Œä¹Ÿä¸æœƒæ–°å¢ 0 å…ƒè¨˜éŒ„

### 4. åŠ å…¥è©³ç´° Debug Logging

**æ–°å¢çš„ Log**:
```typescript
console.log('ğŸ“‹ Parsed Data:', JSON.stringify(parsedData, null, 2));
console.log(`ğŸ¯ Intent detected: ${intent}`);
console.log('ğŸ” Processing QUERY intent...');
console.log(`ğŸ“… Query start date: ${queryStartDate}`);
console.log(`ğŸ“… Query end date: ${queryEndDate} (adjusted to end of day)`);
console.log(`ğŸ“Š Query type: ${queryType}`);
console.log('ğŸ” Query where clause:', JSON.stringify(where, null, 2));
console.log(`âœ… Found ${expenses.length} records`);
console.log('ğŸ’¬ Sending reply:', replyText);
```

**å½±éŸ¿**: å¯ä»¥æ¸…æ¥šè¿½è¹¤æ¯å€‹æ­¥é©Ÿï¼Œå¿«é€Ÿå®šä½å•é¡Œ

### 5. è™•ç†æœªçŸ¥ Intent

**æ–°å¢é‚è¼¯**:
```typescript
} else {
    console.warn('âš ï¸ Unknown intent:', intent);
    // å›è¦†ä½¿ç”¨è€…æç¤ºè¨Šæ¯
}
```

**å½±éŸ¿**: è™•ç† LLM å›å‚³éé æœŸ intent çš„æƒ…æ³

## ğŸ“Š ä¿®æ”¹æª”æ¡ˆæ¸…å–®

1. âœ… `lib/groq.ts` - æ”¹é€² LLM prompt
2. âœ… `app/api/line/webhook/route.ts` - ä¿®æ­£æŸ¥è©¢é‚è¼¯ã€åŠ å…¥é©—è­‰å’Œ logging
3. âœ… `DEBUG_GUIDE.md` - é™¤éŒ¯æŒ‡å—ï¼ˆæ–°å¢ï¼‰
4. âœ… `scripts/quick-test.js` - å¿«é€Ÿæ¸¬è©¦è…³æœ¬ï¼ˆæ–°å¢ï¼‰

## ğŸ§ª æ¸¬è©¦å»ºè­°

### ç«‹å³æ¸¬è©¦
åœ¨ LINE Bot ä¸­æ¸¬è©¦ä»¥ä¸‹è¨Šæ¯ï¼š

1. **æŸ¥è©¢æ¸¬è©¦**:
   - "æˆ‘ä»Šå¤©èŠ±å¤šå°‘éŒ¢?" âœ“ æ‡‰è©²å›è¦†çµ±è¨ˆï¼Œä¸æ–°å¢è¨˜éŒ„
   - "æ˜¨å¤©èŠ±äº†å¤šå°‘" âœ“ æ‡‰è©²å›è¦†çµ±è¨ˆï¼Œä¸æ–°å¢è¨˜éŒ„
   - "é€™å€‹æœˆçš„äº¤é€šè²»" âœ“ æ‡‰è©²å›è¦†çµ±è¨ˆï¼Œä¸æ–°å¢è¨˜éŒ„

2. **è¨˜å¸³æ¸¬è©¦**:
   - "åˆé¤ 100" âœ“ æ‡‰è©²æ–°å¢è¨˜éŒ„
   - "è–ªæ°´ 50000" âœ“ æ‡‰è©²æ–°å¢è¨˜éŒ„

3. **é‚Šç•Œæ¸¬è©¦**:
   - "èŠ±äº†" âœ“ æ‡‰è©²è­˜åˆ¥ç‚º QUERYï¼ˆæ²’æœ‰é‡‘é¡ï¼‰
   - "100" âœ“ å¯èƒ½éœ€è¦æ›´å¤šä¸Šä¸‹æ–‡

### æª¢æŸ¥ Server Log
æ¯æ¬¡æ¸¬è©¦å¾Œæª¢æŸ¥ server log ä¸­çš„ï¼š
- `ğŸ“‹ Parsed Data` - LLM çš„å®Œæ•´å›æ‡‰
- `ğŸ¯ Intent detected` - è­˜åˆ¥çš„æ„åœ–
- `âœ… Found X records` - æŸ¥è©¢çµæœæ•¸é‡

## ğŸ¯ é æœŸçµæœ

### æŸ¥è©¢åŠŸèƒ½
- âœ… ä¸æœƒæ–°å¢ä»»ä½•è¨˜éŒ„
- âœ… æ­£ç¢ºçµ±è¨ˆç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„
- âœ… å›è¦†åŒ…å«ç¸½é¡ã€ç­†æ•¸å’Œå‰ä¸‰å¤§åˆ†é¡

### è¨˜å¸³åŠŸèƒ½
- âœ… æ­£å¸¸æ–°å¢è¨˜éŒ„
- âœ… æ‹’çµ• 0 å…ƒè¨˜éŒ„ä¸¦æç¤ºä½¿ç”¨è€…

## ğŸ“ å¾ŒçºŒå„ªåŒ–å»ºè­°

1. **å–®å…ƒæ¸¬è©¦**: ç‚ºæŸ¥è©¢é‚è¼¯å»ºç«‹è‡ªå‹•åŒ–æ¸¬è©¦
2. **æŸ¥è©¢å¿«å–**: å°å¸¸è¦‹æŸ¥è©¢åŠ å…¥å¿«å–æ©Ÿåˆ¶
3. **æ›´å¤šæ™‚é–“è¡¨é”**: æ”¯æ´ã€Œå‰å¤©ã€ã€ã€Œä¸‹é€±ã€ç­‰
4. **è‡ªç„¶èªè¨€å›è¦†**: è®“æŸ¥è©¢çµæœæ›´å£èªåŒ–
5. **åœ–è¡¨æ•´åˆ**: åœ¨ Web ä»‹é¢é¡¯ç¤ºæŸ¥è©¢çµæœçš„è¦–è¦ºåŒ–åœ–è¡¨

## ğŸš€ éƒ¨ç½²æª¢æŸ¥æ¸…å–®

åœ¨éƒ¨ç½²åˆ° Render ä¹‹å‰ï¼š
- [ ] æœ¬åœ°æ¸¬è©¦æ‰€æœ‰æŸ¥è©¢æ¡ˆä¾‹
- [ ] ç¢ºèª server log æ­£å¸¸è¼¸å‡º
- [ ] æ¸¬è©¦å„ç¨®æ™‚é–“è¡¨é”æ–¹å¼
- [ ] ç¢ºèªä¸æœƒæ–°å¢ 0 å…ƒè¨˜éŒ„
- [ ] æ¸¬è©¦è¨˜å¸³åŠŸèƒ½ä»æ­£å¸¸é‹ä½œ

## ğŸ“ å¦‚æœå•é¡ŒæŒçºŒ

1. æŸ¥çœ‹ `DEBUG_GUIDE.md` é€²è¡Œè¨ºæ–·
2. åŸ·è¡Œ `node scripts/quick-test.js` æ¸¬è©¦ LLM
3. æª¢æŸ¥ server log ä¸­çš„è©³ç´°è³‡è¨Š
4. ç¢ºèª GROQ_API_KEY è¨­å®šæ­£ç¢º
5. æª¢æŸ¥è³‡æ–™åº«ä¸­çš„å¯¦éš›è¨˜éŒ„

---

**ä¿®å¾©æ—¥æœŸ**: 2025-12-06
**ä¿®å¾©ç‰ˆæœ¬**: v1.1.0
**ç‹€æ…‹**: âœ… å·²ä¿®å¾©ï¼Œå¾…æ¸¬è©¦é©—è­‰
